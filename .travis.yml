os:
  - linux
  - osx

branches:
  only:
  - master
  - major
  - stable
  - latest
  - /^\d+\.\d+(\.\d+)?(-\S*)?$/
  - /^release\/\d+\.\d+\.x$/

language: node_js

node_js:
  - 10

env:
  - BUILD=0 BROWSER=Chrome
  - BUILD=1 BROWSER=Chrome
  - BUILD=0 BROWSER=Firefox MOZ_HEADLESS=1
  - BUILD=1 BROWSER=Firefox MOZ_HEADLESS=1

jobs:
  include:
    - name: Chrome (Linux)
      os: linux
      dist: xenial
      services:
        - xvfb
      addons:
        chrome: stable
      before_script:
        # Setup xvfb
        - 'export DISPLAY=:99.0'
        - 'sleep 3'
        # Define target branches
        - TARGET_BRANCH="origin/$TRAVIS_BRANCH"
        - CURRENT_BRANCH="origin/$TRAVIS_PULL_REQUEST_BRANCH"
        - 'if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then
               sh -e TARGET_BRANCH="origin/HEAD^" && CURRENT_BRANCH="origin/HEAD";
          fi'
        # Setup CKEditor 4 testing environment
        - pwd
        - npm install benderjs-cli -g
        - npm i
        # Setup bender test runner
        - cd ..
        - pwd
        - git clone https://github.com/ckeditor/ckeditor4-benderjs-runner.git
        - cd ckeditor4-benderjs-runner
        - git checkout t/1
        - npm i
      script:
        - pwd
        - echo "Running tests based on diff between $TARGET_BRANCH and $CURRENT_BRANCH"
        - npm run start "../../ckeditor4-benderjs-runner-tests/bender-runner.config.json" "$TARGET_BRANCH" "$CURRENT_BRANCH" "chrome" $FULL_RUN

    - name: Firefox (Linux)
      os: linux
      dist: xenial
      services:
        - xvfb
      addons:
        firefox: latest
      before_script:
        # Setup xvfb
        - 'export DISPLAY=:99.0'
        - 'sleep 3'
        # Define target branches
        - TARGET_BRANCH="origin/$TRAVIS_BRANCH"
        - CURRENT_BRANCH="origin/$TRAVIS_PULL_REQUEST_BRANCH"
        - 'if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then
               sh -e TARGET_BRANCH="origin/HEAD^" && CURRENT_BRANCH="origin/HEAD";
          fi'
        # Setup CKEditor 4 testing environment
        - pwd
        - npm install benderjs-cli -g
        - npm i
        # Setup bender test runner
        - cd ..
        - pwd
        - git clone https://github.com/ckeditor/ckeditor4-benderjs-runner.git
        - cd ckeditor4-benderjs-runner
        - git checkout t/1
        - npm i
      script:
        - pwd
        - echo "Running tests based on diff between $TARGET_BRANCH and $CURRENT_BRANCH"
        - npm run start "../../ckeditor4-benderjs-runner-tests/bender-runner.config.json" "$TARGET_BRANCH" "$CURRENT_BRANCH" "firefox" $FULL_RUN

  - name: Safari (OSX)
      os: osx
      before_script:
        # Define target branches
        - TARGET_BRANCH="origin/$TRAVIS_BRANCH"
        - CURRENT_BRANCH="origin/$TRAVIS_PULL_REQUEST_BRANCH"
        - 'if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then
               sh -e TARGET_BRANCH="origin/HEAD^" && CURRENT_BRANCH="origin/HEAD";
          fi'
        # Setup CKEditor 4 testing environment
        - pwd
        - npm install benderjs-cli -g
        - npm i
        # Setup bender test runner
        - cd ..
        - pwd
        - git clone https://github.com/ckeditor/ckeditor4-benderjs-runner.git
        - cd ckeditor4-benderjs-runner
        - npm i
      script:
        - pwd
        - echo "Running tests based on diff between $TARGET_BRANCH and $CURRENT_BRANCH"
        - npm run start "../../ckeditor4-benderjs-runner-tests/bender-runner.config.json" "$TARGET_BRANCH" "$CURRENT_BRANCH" "safari"
